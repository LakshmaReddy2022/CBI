{"version":3,"sources":["../src/cache.js"],"names":["get","stringify","memoize","createContext","useContext","useEffect","globalCache","WeakMap","getItem","func","config","args","cache","updaters","Set","length","normalizer","removeItem","delete","CacheContext","useItem","memoized","cleanupTimeout","clearTimeout","setTimeout","size","cancel"],"mappings":";;AAAA,OAAOA,GAAP,MAAgB,mCAAhB;AACA,OAAOC,SAAP,MAAsB,4BAAtB;AACA,OAAOC,OAAP,MAAoB,UAApB;AACA,SAASC,aAAT,EAAwBC,UAAxB,EAAoCC,SAApC,QAAqD,OAArD;AAEA,IAAMC,WAAW,GAAG,IAAIC,OAAJ,EAApB;AAEA,OAAO,SAASC,OAAT,CAAiBC,IAAjB,EAAuBC,MAAvB,EAA+BC,IAA/B,EAA0D;AAAA,MAArBC,KAAqB,uEAAbN,WAAa;AAC/D,SAAON,GAAG,CACRA,GAAG,CAACY,KAAD,EAAQH,IAAR,EAAc;AAAA,WAAM,IAAIF,OAAJ,EAAN;AAAA,GAAd,CADK,EAERG,MAFQ,EAGR;AAAA,WACER,OAAO,CACL;AAAA,aAAO;AACLW,QAAAA,QAAQ,EAAE,IAAIC,GAAJ;AADL,OAAP;AAAA,KADK;AAKHC,MAAAA,MAAM,EAAE,KALL;AAMHC,MAAAA,UAAU,EAAEf;AANT,OAOAS,MAPA,EADT;AAAA,GAHQ,CAAH,kCAcFC,IAdE,EAAP;AAeD;;AAED,SAASM,UAAT,CAAoBR,IAApB,EAA0BC,MAA1B,EAAkCC,IAAlC,EAA6D;AAAA;;AAAA,MAArBC,KAAqB,uEAAbN,WAAa;;AAC3D,oBAAAM,KAAK,CACFZ,GADH,CACOS,IADP,EAEGT,GAFH,CAEOU,MAFP,GAGGQ,MAHH,0CAGaP,IAHb;AAID;;AAED,OAAO,IAAMQ,YAAY,gBAAGhB,aAAa,CAACG,WAAD,CAAlC;AAEP,OAAO,SAASc,OAAT,GAA0B;AAAA,oCAANT,IAAM;AAANA,IAAAA,IAAM;AAAA;;AAC/B,MAAMC,KAAK,GAAGR,UAAU,CAACe,YAAD,CAAxB;AACA,MAAME,QAAQ,GAAGb,OAAO,MAAP,SAAWG,IAAX,SAAiBC,KAAjB,GAAjB;AACAP,EAAAA,SAAS,CAAC,YAAM;AACd,QAAQQ,QAAR,GAAqCQ,QAArC,CAAQR,QAAR;AAAA,QAAkBS,cAAlB,GAAqCD,QAArC,CAAkBC,cAAlB;;AACA,QAAIA,cAAJ,EAAoB;AAClBC,MAAAA,YAAY,CAACD,cAAD,CAAZ;AACD;;AACD,WAAO,YAAM;AACXD,MAAAA,QAAQ,CAACC,cAAT,GAA0BE,UAAU,CAAC,YAAM;AACzC,YAAI,CAACX,QAAQ,CAACY,IAAd,EAAoB;AAAA;;AAClB,8BAAAJ,QAAQ,CAACK,MAAT,2EAAAL,QAAQ;AACRJ,UAAAA,UAAU,MAAV,SAAcN,IAAd,SAAoBC,KAApB;AACD;AACF,OALmC,EAKjC,CALiC,CAApC;AAMD,KAPD,CALc,CAad;AACD,GAdQ,EAcN,CAACS,QAAD,CAdM,CAAT;AAeA,SAAOA,QAAP;AACD","sourcesContent":["import get from '@postinumero/map-get-with-default';\nimport stringify from 'fast-json-stable-stringify';\nimport memoize from 'memoizee';\nimport { createContext, useContext, useEffect } from 'react';\n\nconst globalCache = new WeakMap();\n\nexport function getItem(func, config, args, cache = globalCache) {\n  return get(\n    get(cache, func, () => new WeakMap()),\n    config,\n    () =>\n      memoize(\n        () => ({\n          updaters: new Set(),\n        }),\n        {\n          length: false,\n          normalizer: stringify,\n          ...config,\n        }\n      )\n  )(...args);\n}\n\nfunction removeItem(func, config, args, cache = globalCache) {\n  cache\n    .get(func)\n    .get(config)\n    .delete(...args);\n}\n\nexport const CacheContext = createContext(globalCache);\n\nexport function useItem(...args) {\n  const cache = useContext(CacheContext);\n  const memoized = getItem(...args, cache);\n  useEffect(() => {\n    const { updaters, cleanupTimeout } = memoized;\n    if (cleanupTimeout) {\n      clearTimeout(cleanupTimeout);\n    }\n    return () => {\n      memoized.cleanupTimeout = setTimeout(() => {\n        if (!updaters.size) {\n          memoized.cancel?.();\n          removeItem(...args, cache);\n        }\n      }, 0);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [memoized]);\n  return memoized;\n}\n"],"file":"cache.js"}